<template>

  <div>
      <DataTableVue :items="vulnerabilities" :workers="workers" :totalitems="totalvulnerabilties" :title="title" :headers="headers"
          :formTitle="formTitle" :url="url" :type_of_items="type_of_items" :totalPages="totalPages" :isnotProject="true"
          @get-items="retrieveVulnerabilties">



          <template v-slot:filters_after_project>
              <td>
                   <v-text-field v-model="name" type="String" label=" search by name"></v-text-field>
                       </td>
                       <td>
                   <v-select
                   v-model="severity"
                    :items="['info','low', 'medium', 'high', 'critical']"
                    label="Severity"

                   >

                   </v-select>


                       </td>

                       <td>
                   <v-text-field v-model="cvss" type="Number" label=" search by cvss"></v-text-field>
                       </td>



          </template>
          <template v-slot:actions="{ item }">





              <v-btn color="primary" @click="OpenDetailCard(item)">
                  Detail Info
              </v-btn>


          </template>

      </DataTableVue>
      <DetailCard :dialog="detail_dialog" @close="closeDetailModal" :item="detail_item"></DetailCard>
  </div>
  </template>

  <script>
  import http from "@/http";
  import DataTableVue from "@/components/DataTable.vue";
  import DetailCard from "@/components/DetailCards/EntityInfoCard.vue"
  import RelatedEntityCardVue from "@/components/DetailCards/RelatedEntityCard.vue";
  export default {
      components: {
          DataTableVue,
          DetailCard,
          RelatedEntityCardVue
      },
      name: "service-list",
      data() {
          return {
              type_of_items: "vulnerabilities",
              url: "common/vulnerabilities/",
              formTitle: "Create Vulnerability",
              title: "Vulnerabilities",
              workers: [],
              services: [],
              vulnerabilities : [],
              singleSelect: false,
              totalvulnerabilties: 0,
              selected: [],
              severity: "",

              detail_dialog: false,
              project: null,
              service_id: null,
              detail_dialog: false,
              project: null,
              projects : [],

              ips : [],
              name: "",
              cvss: null,

              projects: [],
              detail_item: null,
              port: "",

              headers: [
                  { text: "ID", align: "start", sortable: false, value: "id" },
                  { text: "Project ID", sortable: false, value: "project" },
                  { text: "Name", value: "name", sortable: false},
                  { text: "severity", value: "severity", sortable: false },
                  {text: "cvss", value: "cvss", sortable: false},

                  { text: "Actions", value: "actions", sortable: false },

              ],
              page: 1,
              totalPages: 0,
              pageSize: 6,
              pageSizes: [6, 9, 12],
              dialogRunWorker: false,
              CreateDialog: false,

          };
      },
      methods: {
          getRequestParams(name, cvss, severity) {
              let params = {};

              if (cvss){
                  params["cvss__gte"] = cvss;
              }
              if (name) {
                  params["name__icontains"] = name;
              }
              if (severity) {
                  params["severity"] = severity;
              }


              return params;
          },
          retrieveVulnerabilties(params) {


              let extra_params = this.getRequestParams(this.name, this.cvss ,this.severity);
              params = { ...params, ...extra_params };
              console.log("params", params)
              http.getList("Vulnerabilities", params, true)
                  .then((response) => {
                      const { count, results, total_pages } = response.data;
                      this.totalvulnerabilties = count;
                      this.vulnerabilities = results.map(this.getDisplayVulnerability);
                      this.totalPages = total_pages;
                      console.log(response.data);
                  })
                  .catch((e) => {
                      console.log(e);
                  });
          },
          handlePageChange(value) {
              this.page = value;
              this.retrieveVulnerabilties();
          },
          handlePageSizeChange(size) {
              this.pageSize = size;
              this.page = 1;
              this.retrieveVulnerabilties();
          },










          deleteVulnerability(id) {
              http.deleteItem("Vulnerabilities", id)
                  .then(() => {
                      this.refreshList();
                  })
                  .catch((e) => {
                      console.log(e);
                  });
          },
          getDisplayVulnerability(vulnerability) {
              return {
                  id: vulnerability.id,
                  created_at: vulnerability.created_at,
                  updated_at: vulnerability.updated_at,
                  last_scanned_at: vulnerability.last_scanned_at,
                  project: vulnerability.project,
                  name: vulnerability.name,
                  severity: vulnerability.severity,
                  cvss: vulnerability.cvss,
                  description: vulnerability.description,
                  fix_recommendations: vulnerability.fix_recommendations,
                  cwe: vulnerability.cwe,
                  source: vulnerability.source,
                  target: vulnerability.target,
                  type: vulnerability.type,
                  poc: vulnerability.poc,
                  service: vulnerability.service,
                  web_origin: vulnerability.web_origin,

              };
          },


          closeDetailModal() {
              this.detail_dialog = false
              this.$nextTick(() => {
                  this.detail_item - null
              })

          },
          OpenDetailCard(item){
              this.detail_dialog = true
              this.detail_item = item
          },

          OpenVulnerabilityCard(item){
              console.log(item)
              this.vulnerability_dialog = true
              this.filter.service__id = item.id
          },


          closeVulnerabilityCard(){
              this.vulnerability_dialog = false
              this.$nextTick(() => {
                  this.filter.service__id = null
              })
          },
      },

      mounted() {
          let params = {
              page: this.page,
              per_page: this.pageSize,
          };
          this.retrieveVulnerabilties(params);


      },

      watch: {
          CreatDialog(val) {
              val || this.closeCreateModal()
          },




      },
  };
  </script>

  <style>
  .list {
      max-width: 750px;
  }
  </style>
    Footer
