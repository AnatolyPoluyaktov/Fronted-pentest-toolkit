=<template>
  <div>
      <DataTableVue :items="endpoints" :workers="workers" :totalitems="totalendpoints" :title="title" :headers="headers" :formTitle="formTitle" :url="url" :type_of_items="type_of_items" :totalPages="totalPages" :isnotProject="true" @get-items="retrieveEndpoints">


          <template v-slot:filters_after_project>
              <td>
                  <v-text-field v-model="path" type="String" label=" search by path"></v-text-field>
              </td>

              <td>
                  <v-text-field v-model="origin" type="String" label=" search by name"></v-text-field>
              </td>

              <td>
                  <v-text-field v-model="status_code" type="String" label="search by server response code"></v-text-field>
              </td>



          </template>


      </DataTableVue>

  </div>
  </template>


  <script>
  import http from "@/http";
  import DataTableVue from "@/components/DataTable.vue";

  export default {
      components: {
          DataTableVue,

      },
      name: "endpoint-list",
      data() {
          return {
              type_of_items: "Endpoints",
              url: "/common/endpoints/",
              formTitle: "Create Endpoints",
              title: "Endpoints",
              workers: [],
              endpoints: [],
             path: "",
             origin: "",
              status_code: "",
              singleSelect: false,
              totalendpoints: 0,
              selected: [],

              detail_dialog: false,
              project: null,

              detail_dialog: false,

              projects: [],

              detail_item: null,

              UpdatingProjects: "",

              headers: [{
                      text: "ID",
                      align: "start",
                      sortable: false,
                      value: "id"
                  },
                  {
                      text: "Project ID",
                      sortable: false,
                      value: "project"
                  },
                  {
                      text: "Endpoint",
                      sortable: false,
                      value: "endpoint"
                  },

                  {
                      text: "Origin",
                      sortable: false,
                      value: "origin"
                  },
                  {
                      text: "Response Status Code",
                      sortable: false,
                      value: "status_code"
                  },


              ],
              page: 1,
              totalPages: 0,
              pageSize: 6,
              pageSizes: [6, 9, 12],
              dialogRunWorker: false,
              CreateDialog: false,

          };
      },
      methods: {
          getRequestParams(path,origin, status_code) {
              let params = {};

              if (path) {
                  params["path__icontains"] = path;
              }
              if (origin) {
                  params["origin__origin__icontains"] = origin;
              }
              if (status_code) {
                  params["status_code__lte"] = status_code;
              }

              return params;
          },
          retrieveEndpoints(params) {

              let extra_params = this.getRequestParams(this.path,this.origin, this.status_code);
              params = {
                  ...params,
                  ...extra_params
              };
              console.log("params", params)
              http.getList("Endpoints", params, true)
                  .then((response) => {
                      const {
                          count,
                          results,
                          total_pages
                      } = response.data;
                      this.totalendpoints = count;
                      this.endpoints = results.map(this.getDisplayEndpoint);
                      this.totalPages = total_pages;
                      console.log(response.data);
                  })
                  .catch((e) => {
                      console.log(e);
                  });
          },
          handlePageChange(value) {
              this.page = value;
              this.retrieveEndpoints();
          },
          handlePageSizeChange(size) {
              this.pageSize = size;
              this.page = 1;
              this.retrieveEndpoints();
          },

          async getProjects(val) {

              try {
                  let response = (
                      await http.getList(
                          "Projects", {
                              name__icontains: val
                          }, true

                      )
                  ).data;

                  const {
                      next,
                      results
                  } = response
                  this.projects = results

                  console.log(response)

                  // this.projects.push(...results.map(this.getDisplayProject))
                  // this.has_next_page_projects = next !== nulls
              } catch (error) {
                  console.error(error);
                  // expected output: ReferenceError: nonExistentFunction is not defined
                  // Note - error messages will vary depending on browser
              }

          },

          refreshList() {
              this.retrieveEndpoints();
          },

          deleteEndpoints(id) {
              http.deleteItem("/common/endpoints/", id)
                  .then(() => {
                      this.refreshList();
                  })
                  .catch((e) => {
                      console.log(e);
                  });
          },
          getDisplayEndpoint(endpoint) {
              return {

                  id: endpoint.id,
                  endpoint: endpoint.endpoint,
                  origin: endpoint.origin,
                  project: endpoint.project,
                  status_code: endpoint.status_code,


              };
          },


          closeDetailModal() {
              this.detail_dialog = false
              this.$nextTick(() => {
                  this.detail_item - null
              })

          },
          OpenDetailCard(item) {
              this.detail_dialog = true
              this.detail_item = item
          },




      },

      mounted() {
          let params = {
              page: this.page,
              per_page: this.pageSize,
          };
          this.retrieveEndpoints(params);

      },

      watch: {
          CreatDialog(val) {
              val || this.closeCreateModal()
          },

          UpdatingProjects(val) {
              this.getProjects(val)
          },


      },
  };
  </script>


  <style>
  .list {
      max-width: 750px;
  }
  </style>
      Footer
