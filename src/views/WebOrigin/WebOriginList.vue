<template>
  <div>
      <DataTableVue :items="weborigins" :workers="workers" :totalitems="totalweborigins" :title="title" :headers="headers" :formTitle="formTitle" :url="api_url" :type_of_items="type_of_items" :totalPages="totalPages" :isnotProject="true" @get-items="retrieveWebOrigins">

          <template v-slot:createmodal>

              <v-dialog hide-overlay v-model="CreateDialog" max-width="500px">
                  <template v-slot:activator="{ on, attrs }">
                      <v-btn color="primary" dark class="mb-2 ma-2" v-bind="attrs" v-on="on">
                          Add WebOrigin
                      </v-btn>
                  </template>
                  <v-card>
                      <v-card-title>
                          <span class="text-h5">Create WebOrigin</span>
                      </v-card-title>

                      <v-card-text>

                          <v-container>
                              <v-row>

                                <v-col cols="12" sm="6" md="4">
                                    <v-autocomplete v-model="CreateItem.project" :items="projects" :search-input.sync="UpdatingProjects" item-text="name" label="Search Projects" placeholder="Start typing to Search" return-object required></v-autocomplete>
                                </v-col>
                                  <v-col cols="12" sm="6" md="4">
                                      <v-text-field v-model="CreateItem.url" label="url"></v-text-field>
                                  </v-col>


                              </v-row>
                          </v-container>
                      </v-card-text>
                      <v-card-actions>
                          <v-spacer></v-spacer>
                          <v-btn color="blue darken-1" text @click="closeCreateModal">
                              Cancel
                          </v-btn>
                          <v-btn color="blue darken-1" text @click="save">
                              Save
                          </v-btn>
                      </v-card-actions>

                  </v-card>

              </v-dialog>

          </template>
          <template v-slot:filters_after_project>
              <td>
                  <v-text-field v-model="url" type="String" label=" search by name"></v-text-field>
              </td>

          </template>
          <template v-slot:actions="{ item }">

              <v-btn color="primary" @click="OpenDetailCard(item)">
                  Detail Info
              </v-btn>

          </template>

      </DataTableVue>
      <DetailCard :dialog="detail_dialog" @close="closeDetailModal" :item="detail_item"></DetailCard>
  </div>
  </template>


  <script>
  import http from "@/http";
  import DataTableVue from "@/components/DataTable.vue";
  import DetailCard from "@/components/DetailCards/EntityInfoCard.vue"
  import RelatedEntityCardVue from "@/components/DetailCards/RelatedEntityCard.vue";
  export default {
      components: {
          DataTableVue,
          DetailCard,
          RelatedEntityCardVue
      },
      name: "service-list",
      data() {
          return {
              type_of_items: "origins",
              api_url: "/common/web-origins/",
              formTitle: "Create WebOrigins",
              title: "Web Origins",
              workers: ["nuclei-scan"],
              weborigins: [],
             url: "",

              singleSelect: false,
              totalweborigins: 0,
              selected: [],

              detail_dialog: false,
              project: null,

              detail_dialog: false,

              projects: [],

              detail_item: null,

              UpdatingProjects: "",

              CreateItem: {

                  url: "",

                  project: {
                      id: null,
                      name: ""
                  }

              },
              headers: [{
                      text: "ID",
                      align: "start",
                      sortable: false,
                      value: "id"
                  },
                  {
                      text: "Project ID",
                      sortable: false,
                      value: "project"
                  },
                  {
                      text: "ORIGIN",
                      sortable: false,
                      value: "url"
                  },
                  {
                        text: "Endpoints Number",
                        value: "endpoint_count",
                        sortable: false
                  },

                  {
                      text: "Actions",
                      value: "actions",
                      sortable: false
                  },


              ],
              page: 1,
              totalPages: 0,
              pageSize: 6,
              pageSizes: [6, 9, 12],
              dialogRunWorker: false,
              CreateDialog: false,

          };
      },
      methods: {
          getRequestParams(url) {
              let params = {};

              if (url) {
                  params["url__icontains"] = url;
              }

              return params;
          },
          retrieveWebOrigins(params) {

              let extra_params = this.getRequestParams(this.url);
              params = {
                  ...params,
                  ...extra_params
              };
              console.log("params", params)
              http.getList("/common/web-origins/", params, true)
                  .then((response) => {
                      const {
                          count,
                          results,
                          total_pages
                      } = response.data;
                      this.totalweborigins = count;
                      this.weborigins = results.map(this.getDisplayWebOrigin);
                      this.totalPages = total_pages;
                      console.log(response.data);
                  })
                  .catch((e) => {
                      console.log(e);
                  });
          },
          handlePageChange(value) {
              this.page = value;
              this.retrieveWebOrigins();
          },
          handlePageSizeChange(size) {
              this.pageSize = size;
              this.page = 1;
              this.retrieveWebOrigins();
          },

          async getProjects(val) {

              try {
                  let response = (
                      await http.getList(
                          "Projects", {
                              name__icontains: val
                          }, true

                      )
                  ).data;

                  const {
                      next,
                      results
                  } = response
                  this.projects = results

                  console.log(response)

                  // this.projects.push(...results.map(this.getDisplayProject))
                  // this.has_next_page_projects = next !== nulls
              } catch (error) {
                  console.error(error);
                  // expected output: ReferenceError: nonExistentFunction is not defined
                  // Note - error messages will vary depending on browser
              }

          },

          refreshList() {
              this.retrieveWebOrigins();
          },

          deleteWebOrigin(id) {
              http.deleteItem("/common/web-origins/", id)
                  .then(() => {
                      this.refreshList();
                  })
                  .catch((e) => {
                      console.log(e);
                  });
          },
          getDisplayWebOrigin(WebOrigin) {
              return {

                  id: WebOrigin.id,
                  url: WebOrigin.url,
                  project: WebOrigin.project,
                  endpoint_count : WebOrigin.endpoint_count,



              };
          },

          async save() {
              let params = {}



              let response = (
                  await http.createItem(
                      "WebOrigins", {
                          project: this.CreateItem.project.id,
                          url: this.CreateItem.url,

                      },
                      true
                  )
              )
              this.closeCreateModal()
              window.location.reload()
          },

          closeDetailModal() {
              this.detail_dialog = false
              this.$nextTick(() => {
                  this.detail_item - null
              })

          },
          OpenDetailCard(item) {
              this.detail_dialog = true
              this.detail_item = item
          },



          closeCreateModal() {
              this.CreateDialog = false
              this.$nextTick(() => {
                  this.CreateItem = Object.assign({}, {

                      url: "",

                      project: {
                          id: null,
                          name: ""
                      },
                  })
              })
          },

      },

      mounted() {
          let params = {
              page: this.page,
              per_page: this.pageSize,
          };
          this.retrieveWebOrigins(params);

      },

      watch: {
          CreatDialog(val) {
              val || this.closeCreateModal()
          },

          UpdatingProjects(val) {
              this.getProjects(val)
          },


      },
  };
  </script>


  <style>
  .list {
      max-width: 750px;
  }
  </style>
      Footer
