<template>
<div>
    <DataTableVue :items="ips" :workers="workers" :totalitems="totalips" :title="title" :headers="headers" :formTitle="formTitle" :url="url" :type_of_items="type_of_items" :totalPages="totalPages" :isnotProject="true" @get-items="retrieveIps">

        <template v-slot:createmodal>

            <v-dialog hide-overlay v-model="CreateDialog" max-width="500px">
                <template v-slot:activator="{ on, attrs }">
                    <v-btn color="primary" dark class="mb-2 ma-2" v-bind="attrs" v-on="on">
                        Add IP
                    </v-btn>
                </template>
                <v-card>
                    <v-card-title>
                        <span class="text-h5">Create IP</span>
                    </v-card-title>

                    <v-card-text>

                        <v-container>
                            <v-row>
                                <v-col cols="12" sm="6" md="4">
                                    <v-text-field v-model="CreateItem.ip" label="name"></v-text-field>
                                </v-col>

                                <v-col cols="12" sm="6" md="4">
                                    <v-autocomplete v-model="CreateItem.project" :items="projects" :search-input.sync="UpdatingProjects" item-text="name" label="Search Projects" placeholder="Start typing to Search" return-object required></v-autocomplete>
                                </v-col>

                                <v-col cols="12" sm="6" md="4">
                                    <v-autocomplete v-model="CreateItem.domain" :items="domains" :search-input.sync="UpdatingDomains" item-text="name" label="Search Domains" placeholder="Start typing to Search" return-object></v-autocomplete>
                                </v-col>

                            </v-row>
                        </v-container>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="blue darken-1" text @click="closeCreateModal">
                            Cancel
                        </v-btn>
                        <v-btn color="blue darken-1" text @click="save">
                            Save
                        </v-btn>
                    </v-card-actions>

                </v-card>

            </v-dialog>

        </template>
        <template v-slot:filters_after_project>
            <td>
                <v-text-field v-model="ip" type="String" label=" search by ip"></v-text-field>
            </td>

        </template>
        <template v-slot:actions="{ item }">

            <v-btn color="primary" @click="OpenDetailCard(item)">
                Detail Info
            </v-btn>

        </template>

    </DataTableVue>
    <DetailCard :dialog="detail_dialog" @close="closeDetailModal" :item="detail_item"></DetailCard>
</div>
</template>


<script>
import http from "@/http";
import DataTableVue from "@/components/DataTable.vue";
import DetailCard from "@/components/DetailCards/EntityInfoCard.vue"
import RelatedEntityCardVue from "@/components/DetailCards/RelatedEntityCard.vue";
export default {
    components: {
        DataTableVue,
        DetailCard,
        RelatedEntityCardVue
    },
    name: "service-list",
    data() {
        return {
            type_of_items: "ips",
            url: "common/ips/",
            formTitle: "Create IP",
            title: "IPs",
            workers: ["nmap-scan"],
            ips: [],
            ip: "",
            singleSelect: false,
            totalips: 0,
            selected: [],

            detail_dialog: false,
            project: null,

            detail_dialog: false,

            projects: [],

            detail_item: null,

            UpdatingProjects: "",
            UpdatingDomains: "",
            CreateItem: {

                ip: "",
                domain: {
                    id: null,
                    name: ""
                },
                project: {
                    id: null,
                    name: ""
                }

            },
            headers: [{
                    text: "ID",
                    align: "start",
                    sortable: false,
                    value: "id"
                },
                {
                    text: "Project ID",
                    sortable: false,
                    value: "project"
                },
                {
                    text: "ip",
                    sortable: false,
                    value: "ip"
                },

                {
                    text: "Actions",
                    value: "actions",
                    sortable: false
                },

            ],
            page: 1,
            totalPages: 0,
            pageSize: 6,
            pageSizes: [6, 9, 12],
            dialogRunWorker: false,
            CreateDialog: false,
            domains : [],

        };
    },
    methods: {
        getRequestParams(ip) {
            let params = {};

            if (ip) {
                params["ip__icontains"] = ip;
            }

            return params;
        },
        retrieveIps(params) {

            let extra_params = this.getRequestParams(this.ip);
            params = {
                ...params,
                ...extra_params
            };
            console.log("params", params)
            http.getList("Ips", params, true)
                .then((response) => {
                    const {
                        count,
                        results,
                        total_pages
                    } = response.data;
                    this.totalips = count;
                    this.ips = results.map(this.getDisplayIp);
                    this.totalPages = total_pages;
                    console.log(response.data);
                })
                .catch((e) => {
                    console.log(e);
                });
        },
        handlePageChange(value) {
            this.page = value;
            this.retrieveIps();
        },
        handlePageSizeChange(size) {
            this.pageSize = size;
            this.page = 1;
            this.retrieveips();
        },

        async getDomains(val) {

            try {
                let response = (
                    await http.getList(
                        "Domains", {
                            name__icontains: val
                        }, true

                    )
                ).data;

                const {
                    next,
                    results
                } = response
                this.domains = results

                console.log(response)

                // this.projects.push(...results.map(this.getDisplayProject))
                // this.has_next_page_projects = next !== nulls
            } catch (error) {
                console.error(error);
                // expected output: ReferenceError: nonExistentFunction is not defined
                // Note - error messages will vary depending on browser
            }

        },

        async getProjects(val) {

            try {
                let response = (
                    await http.getList(
                        "Projects", {
                            name__icontains: val
                        }, true

                    )
                ).data;

                const {
                    next,
                    results
                } = response
                this.projects = results

                console.log(response)

                // this.projects.push(...results.map(this.getDisplayProject))
                // this.has_next_page_projects = next !== nulls
            } catch (error) {
                console.error(error);
                // expected output: ReferenceError: nonExistentFunction is not defined
                // Note - error messages will vary depending on browser
            }

        },

        refreshList() {
            this.retrieveIps();
        },

        deleteIps(id) {
            http.deleteItem("Ips", id)
                .then(() => {
                    this.refreshList();
                })
                .catch((e) => {
                    console.log(e);
                });
        },
        getDisplayIp(ip) {
            return {
                id: ip.id,
                project: ip.project,
                ip: ip.ip,
                service_count: ip.services_count,
                domains: ip.common_domain,
                subdomains: ip.common_subdomain,
                subnet: ip.subnet,
                status: ip.status,

                source: ip.source,
                created_at: ip.created_at,
                updated_at: ip.updated_at,
                last_scanned_at: ip.last_scanned_at,

            };
        },

        async save() {
            let params = {}

            if (this.CreateItem.domain.id != null) {
                params["domain"] = this.CreateItem.domain.id
            }
            let post_data = {
                ip: this.CreateItem.ip,

            }

            let response = (
                await http.createItem(
                    "Ips", {
                        project: this.CreateItem.project.id,
                        ips: [post_data],
                        ...params,
                        source: "Upload",
                    },
                    true
                )
            )
            this.closeCreateModal()
            //window.location.reload()
        },

        closeDetailModal() {
            this.detail_dialog = false
            this.$nextTick(() => {
                this.detail_item - null
            })

        },
        OpenDetailCard(item) {
            this.detail_dialog = true
            this.detail_item = item
        },

        closeCreateModal() {
            this.CreateDialog = false
            this.$nextTick(() => {
                this.CreateItem = Object.assign({}, {

                    ip: "",
                    domain: {
                        id: null,
                        name: ""
                    },
                    project: {
                        id: null,
                        name: ""
                    },
                })
            })
        },

    },

    mounted() {
        let params = {
            page: this.page,
            per_page: this.pageSize,
        };
        this.retrieveIps(params);

    },

    watch: {
        CreatDialog(val) {
            val || this.closeCreateModal()
        },

        UpdatingProjects(val) {
            this.getProjects(val)
        },
        UpdatingDomains(val) {
            this.getDomains(val)
        },

    },
};
</script>


<style>
.list {
    max-width: 750px;
}
</style>
    Footer
