<template>
    <div>
        <DataTableVue :items="emails" :workers="workers" :totalitems="totalemails" :title="title" :headers="headers" :formTitle="formTitle" :url="url" :type_of_items="type_of_items" :totalPages="totalPages" :isnotProject="true" @get-items="retrieveEmails">

            <template v-slot:createmodal>

                <v-dialog hide-overlay v-model="CreateDialog" max-width="500px">
                    <template v-slot:activator="{ on, attrs }">
                        <v-btn color="primary" dark class="mb-2 ma-2" v-bind="attrs" v-on="on">
                            Add Email
                        </v-btn>
                    </template>
                    <v-card>
                        <v-card-title>
                            <span class="text-h5">Create Email</span>
                        </v-card-title>

                        <v-card-text>

                            <v-container>
                                <v-row>

                                  <v-col cols="12" sm="6" md="4">
                                      <v-autocomplete v-model="CreateItem.project" :items="projects" :search-input.sync="UpdatingProjects" item-text="name" label="Search Projects" placeholder="Start typing to Search" return-object required></v-autocomplete>
                                  </v-col>
                                    <v-col cols="12" sm="6" md="4">
                                        <v-text-field v-model="CreateItem.email" label="email"></v-text-field>
                                    </v-col>


                                </v-row>
                            </v-container>
                        </v-card-text>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="blue darken-1" text @click="closeCreateModal">
                                Cancel
                            </v-btn>
                            <v-btn color="blue darken-1" text @click="save">
                                Save
                            </v-btn>
                        </v-card-actions>

                    </v-card>

                </v-dialog>

            </template>
            <template v-slot:filters_after_project>
                <td>
                    <v-text-field v-model="email" type="String" label=" search by email"></v-text-field>
                </td>

            </template>


        </DataTableVue>

    </div>
    </template>


    <script>
    import http from "@/http";
    import DataTableVue from "@/components/DataTable.vue";

    export default {
        components: {
            DataTableVue,

        },
        name: "email-list",
        data() {
            return {
                type_of_items: "Emails",
                url: "/common/emails/",
                formTitle: "Create Emails",
                title: "Emails",
                workers: ["h8mail-leaks"],
                emails: [],


                singleSelect: false,
                totalemails: 0,
                selected: [],

                detail_dialog: false,
                project: null,

                detail_dialog: false,

                projects: [],

                detail_item: null,
                email: "",

                UpdatingProjects: "",

                CreateItem: {

                    email: "",

                    project: {
                        id: null,
                        name: ""
                    }

                },
                headers: [{
                        text: "ID",
                        align: "start",
                        sortable: false,
                        value: "id"
                    },
                    {
                        text: "Project ID",
                        sortable: false,
                        value: "project"
                    },
                    {
                        text: "Email",
                        sortable: false,
                        value: "email"
                    },
                    {
                        text: "leaked",
                        sortable: false,
                        value: "have_leaks"
                    },
                    {
                        text: "Created at",
                        value: "created_at",
                        sortable: false
                    },
                    {
                        text: "Updated at",
                        value: "updated_at",
                        sortable: false
                    },
                    {
                        text: "Last scanned at",
                        value: "last_scanned_at",
                        sortable: false
                    }



                ],
                page: 1,
                totalPages: 0,
                pageSize: 6,
                pageSizes: [6, 9, 12],
                dialogRunWorker: false,
                CreateDialog: false,

            };
        },
        methods: {
            getRequestParams(email) {
                let params = {};

                if (email) {
                    params["email__icontains"] =email;
                }

                return params;
            },
            retrieveEmails(params) {

                let extra_params = this.getRequestParams(this.email);
                params = {
                    ...params,
                    ...extra_params
                };
                console.log("params", params)
                http.getList("/common/emails/", params, true)
                    .then((response) => {
                        const {
                            count,
                            results,
                            total_pages
                        } = response.data;
                        this.totalemails = count;
                        this.emails = results.map(this.getDisplayEmail);
                        this.totalPages = total_pages;
                        console.log(response.data);
                    })
                    .catch((e) => {
                        console.log(e);
                    });
            },
            handlePageChange(value) {
                this.page = value;
                this.retrieveEmails();
            },
            handlePageSizeChange(size) {
                this.pageSize = size;
                this.page = 1;
                this.retrieveEmails();
            },

            async getProjects(val) {

                try {
                    let response = (
                        await http.getList(
                            "Projects", {
                                name__icontains: val
                            }, true

                        )
                    ).data;

                    const {
                        next,
                        results
                    } = response
                    this.projects = results

                    console.log(response)

                    // this.projects.push(...results.map(this.getDisplayProject))
                    // this.has_next_page_projects = next !== nulls
                } catch (error) {
                    console.error(error);
                    // expected output: ReferenceError: nonExistentFunction is not defined
                    // Note - error messages will vary depending on browser
                }

            },

            refreshList() {
                this.retrieveEmails();
            },

            deleteEmail(id) {
                http.deleteItem("/common/emails/", id)
                    .then(() => {
                        this.refreshList();
                    })
                    .catch((e) => {
                        console.log(e);
                    });
            },
            getDisplayEmail(email) {
                return {

                    id: email.id,
                    email: email.email,
                    project: email.project,
                    have_leaks: email.have_leaks,
                    created_at: email.created_at,
                    updated_at: email.updated_at,
                    last_scanned_at: email.last_scanned_at,




                };
            },

            async save() {
                let params = {}



                let response = (
                    await http.createItem(
                        "Emails", {
                            project: this.CreateItem.project.id,
                            email: this.CreateItem.email,

                        },
                        true
                    )
                )
                this.closeCreateModal()
                window.location.reload()
            },

            closeDetailModal() {
                this.detail_dialog = false
                this.$nextTick(() => {
                    this.detail_item - null
                })

            },
            OpenDetailCard(item) {
                this.detail_dialog = true
                this.detail_item = item
            },



            closeCreateModal() {
                this.CreateDialog = false
                this.$nextTick(() => {
                    this.CreateItem = Object.assign({}, {

                        email: "",

                        project: {
                            id: null,
                            name: ""
                        },
                    })
                })
            },

        },

        mounted() {
            let params = {
                page: this.page,
                per_page: this.pageSize,
            };
            this.retrieveEmails(params);

        },

        watch: {
            CreatDialog(val) {
                val || this.closeCreateModal()
            },

            UpdatingProjects(val) {
                this.getProjects(val)
            },


        },
    };
    </script>


    <style>
    .list {
        max-width: 750px;
    }
    </style>
        Footer
