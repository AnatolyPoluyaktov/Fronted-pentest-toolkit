<template>

  <div>
      <DataTableVue :items="subnets" :workers="workers" :totalitems="totalsubnets" :title="title" :headers="headers"
          :formTitle="formTitle" :url="url" :type_of_items="type_of_items" :totalPages="totalPages" :isnotProject="true"
          @get-items="retrieveSubnets">

          <template v-slot:createmodal>

              <v-dialog hide-overlay v-model="CreateDialog" max-width="500px">
                                  <template v-slot:activator="{ on, attrs }">
                                      <v-btn color="primary" dark class="mb-2 ma-2" v-bind="attrs" v-on="on">
                                          Add subnet
                                      </v-btn>
                                  </template>
              <v-card>
                  <v-card-title>
                      <span class="text-h5">Create subnet</span>
                  </v-card-title>

                  <v-card-text>

                      <v-container>
                          <v-row>
                              <v-col cols="12" sm="6" md="4">
                                  <v-text-field v-model="CreateItem.subnet" label="subnet"></v-text-field>
                              </v-col>


                              <v-col cols="12" sm="6" md="4">
                                  <v-autocomplete v-model="CreateItem.project" :items="projects"
                                      :search-input.sync="UpdatingProjects" item-text="name" label="Search Projects"
                                      placeholder="Start typing to Search" return-object required></v-autocomplete>
                              </v-col>


                          </v-row>
                      </v-container>
                  </v-card-text>
                  <v-card-actions>
                      <v-spacer></v-spacer>
                      <v-btn color="blue darken-1" text @click="closeCreateModal">
                          Cancel
                      </v-btn>
                      <v-btn color="blue darken-1" text @click="save">
                          Save
                      </v-btn>
                  </v-card-actions>

              </v-card>

              </v-dialog>

          </template>
          <template v-slot:filters_after_project>
              <td>
                   <v-text-field v-model="subnet" type="String" label=" search by name"></v-text-field>
                       </td>



          </template>
          <template v-slot:actions="{ item }">





              <v-btn color="primary" @click="OpenDetailCard(item)">
                  Detail Info
              </v-btn>


          </template>

      </DataTableVue>
      <DetailCard :dialog="detail_dialog" @close="closeDetailModal" :item="detail_item"></DetailCard>
  </div>
  </template>

  <script>
  import http from "@/http";
  import DataTableVue from "@/components/DataTable.vue";
  import DetailCard from "@/components/DetailCards/EntityInfoCard.vue"
  import RelatedEntityCardVue from "@/components/DetailCards/RelatedEntityCard.vue";
  export default {
      components: {
          DataTableVue,
          DetailCard,
          RelatedEntityCardVue
      },
      name: "service-list",
      data() {
          return {
              type_of_items: "subnets",
              url: "common/subnets/",
              formTitle: "Create subnet",
              title: "Subnets",
              workers: ["nmap-scan"],
              subnets: [],
              subnet: "",
              singleSelect: false,
              totalsubnets: 0,
              selected: [],


              detail_dialog: false,
              project: null,

              detail_dialog: false,

              projects : [],


              detail_item: null,

              UpdatingProjects: "",
              CreateItem: {

                  subnet: "",

                  project: { id: null, name: ""}

              },
              headers: [
                  { text: "ID", align: "start", sortable: false, value: "id" },
                  { text: "Project ID", sortable: false, value: "project" },
                  { text: "Subnet", sortable: false, value: "subnet" },

                  { text: "Actions", value: "actions", sortable: false },

              ],
              page: 1,
              totalPages: 0,
              pageSize: 6,
              pageSizes: [6, 9, 12],
              dialogRunWorker: false,
              CreateDialog: false,

          };
      },
      methods: {
          getRequestParams(subnet) {
              let params = {};

              if (subnet) {
                  params["subnet__icontains"] = subnet;
              }

              return params;
          },
          retrieveSubnets(params) {


              let extra_params = this.getRequestParams(this.subnet);
              params = { ...params, ...extra_params };
              console.log("params", params)
              http.getList("Subnets", params, true)
                  .then((response) => {
                      const { count, results, total_pages } = response.data;
                      this.totalsubnets = count;
                      this.subnets = results.map(this.getDisplaySubnet);
                      console.log(this.subnets)
                      this.totalPages = total_pages;
                      console.log(response.data);
                  })
                  .catch((e) => {
                      console.log(e);
                  });
          },
          handlePageChange(value) {
              this.page = value;
              this.retrieveSubnets();
          },
          handlePageSizeChange(size) {
              this.pageSize = size;
              this.page = 1;
              this.retrieveSubnets();
          },

          async getProjects(val) {

              try {
                  let response = (
                      await http.getList(
                          "Projects", { name__icontains: val }, true

                      )
                  ).data;

                  const { next, results } = response
                  this.projects = results



                  // this.projects.push(...results.map(this.getDisplayProject))
                  // this.has_next_page_projects = next !== nulls
              } catch (error) {
                  console.error(error);
                  // expected output: ReferenceError: nonExistentFunction is not defined
                  // Note - error messages will vary depending on browser
              }

          },



          refreshList() {
              this.retrieveSubnets();
          },


          deleteSubnets(id) {
              http.deleteItem("Sunbets", id)
                  .then(() => {
                      this.refreshList();
                  })
                  .catch((e) => {
                      console.log(e);
                  });
          },
          getDisplaySubnet(subnet) {
              return {
            id : subnet.id,
            ips_count: subnet.ips_count,
            subnet: subnet.subnet,
            project: subnet.project,
            source: subnet.source,
            ip_range: subnet.iprange,
            address: subnet.address,
            description: subnet.description,
            country: subnet.country,
            created_at: subnet.created_at,
            updated_at: subnet.updated_at,
            last_scanned_at: subnet.last_scanned_at,

              };
          },

          async save() {


              let response = (
                  await http.createItem(
                      "Subnets",
                      {
                          project: this.CreateItem.project.id,
                          subnet: this.CreateItem.subnet,

                      }
                      ,
                      true
                  )
              )
              this.closeCreateModal()
             //window.location.reload()
          },

          closeDetailModal() {
              this.detail_dialog = false
              this.$nextTick(() => {
                  this.detail_item - null
              })

          },
          OpenDetailCard(item){
              this.detail_dialog = true
              this.detail_item = item
          },




          closeCreateModal() {
              this.CreateDialog = false
              this.$nextTick(() => {
                  this.CreateItem = Object.assign({}, {

              subnet: "",

              project:{id: null, name: ""} ,
          })
              })
          },


      },

      mounted() {
          let params = {
              page: this.page,
              per_page: this.pageSize,
          };
          this.retrieveSubnets(params);


      },

      watch: {
          CreatDialog(val) {
              val || this.closeCreateModal()
          },


          UpdatingProjects(val){
              this.getProjects(val)
          }

      },
  };
  </script>

  <style>
  .list {
      max-width: 750px;
  }
  </style>
    Footer
