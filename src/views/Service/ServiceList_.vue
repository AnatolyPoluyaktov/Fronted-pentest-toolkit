<template>
  <v-row align="center" class=" px-3 mx-auto">


    <v-col cols="12" sm="12">
      <v-row>
        <v-col cols="4" sm="3">
          <v-select
            v-model="pageSize"
            :items="pageSizes"
            label="Items per Page"
            @change="handlePageSizeChange"
          ></v-select>
        </v-col>



      </v-row>

      <v-row >
        <v-col >
          <v-btn  small @click="page = 1; retrieveServices();">
            Search
          </v-btn>
        </v-col>
      </v-row>
    </v-col>

    <v-col cols="12" sm="12">
      <v-card class="mx-auto" tile>
        <v-card-title>Services</v-card-title>

        <v-data-table

        v-model="selected"
        :single-select="singleSelect"
          :headers="headers"
          :items="services"
          show-select
          disable-pagination
          :hide-default-footer="true"
          @click:row="handleClick"
          class="elevation-1"
        >
        <template v-slot:top>
      <v-toolbar
        flat
      >
        <v-toolbar-title>Services</v-toolbar-title>
        <v-divider
          class="mx-4"
          inset
          vertical
        ></v-divider>
        <v-spacer></v-spacer>
        <v-dialog
          v-model="dialogRunWorker"
          max-width="500px"
        >
          <template v-slot:activator="{ on, attrs }">
            <v-btn
              color="primary"
              dark
              class="mb-2"
              v-bind="attrs"
              v-on="on"
            >
              Start Scan
            </v-btn>
          </template>
          <v-card>
            <v-card-title>
              <span class="text-h5"> Run Task </span>
            </v-card-title>

            <v-card-text>
              <v-container>
                <v-row>
                <v-col
                    cols="12"
                    sm="7"
                    md="5"
                  >
                <v-autocomplete
                v-model="project"
                :items="projects"
                item-text="name"
                item-value="id"
                label="Search project"
                return-object
                autocomplete="off"
                >
                <template v-slot:append-item>
                  <div v-intersect="onIntersect" class="pa-4 teal--text">
                     Loading more projects ...
                  </div>
                </template>
              </v-autocomplete>
              </v-col>
                </v-row>

              </v-container>
            </v-card-text>

            <v-card-actions>
              <v-spacer></v-spacer>
              <v-btn
                color="blue darken-1"
                text
                @click="close"
              >
                Cancel
              </v-btn>
              <v-btn
                color="blue darken-1"
                text
                @click="startScan"
              >
                Start
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>
      </v-toolbar>
    </template>
    <template v-slot:body.prepend>



            <tr>

      <slot name="filters_before_project">
              <td>

              </td>
              <td>

              </td>

            </slot>
               <td>
                <v-text-field v-model="project" type="number" label="project id"></v-text-field>
              </td>
            <slot name="filters_after_project">
              <td>

              </td>
            </slot>
            </tr>


        </v-data-table>
         <DetailService :service_id="service_id" :dialog="detail_dialog" @close="closeDetail" ></DetailService>

      </v-card>
    </v-col>
    <v-col cols="12" mx="9">
          <v-pagination
            v-model="page"
            :length="totalPages"
            total-visible="7"
            next-icon="mdi-menu-right"
            prev-icon="mdi-menu-left"
            @input="handlePageChange"
          ></v-pagination>
        </v-col>
  </v-row>
</template>

<script>
import http from "@/http";
import DetailService from "@/components/DialogsDetails/DetailService.vue";
export default {
  components: {
        DetailService
    },
  name: "service-list",
  data() {
    return {
      services: [],
      singleSelect: false,
      totalservices : 0,
      selected: [],
      project: null,
      service_id: null,
      detail_dialog: false,
      project: null,
      ip:"",
      projects: [],
      projects_per_page: 2,
      prooject_page:1,
      has_next_page_project: true,
      port:"",
      headers: [
        { text: "ID", align: "start", sortable: false, value: "id",width: '200px' },
        { text: "Project ID",  sortable: false, value: "project",width: '200px' },
        { text: "Ip", value: "ip", sortable: false,width: '200px' },
        { text: "port", value: "port", sortable: false,width: '200px' },
        { text: "Actions", value: "actions", sortable: false ,width: '200px'},
      ],
      page: 1,
      totalPages: 0,
      pageSize: 6,
      pageSizes: [6,9,12],
      dialogRunWorker: false,

    };
  },
  methods: {
    getRequestParams(project, page, pageSize) {
      let params = {};
      if (project) {
        params["project"] = project;
      }
      if (page) {
        params["page"] = page ;
      }
      if (pageSize) {
        params["per_page"] = pageSize;
      }
      return params;
    },
    retrieveServices() {
      const params = this.getRequestParams(
        this.project,
        this.page,
        this.pageSize
      );
      http.getList("Services",params, true)
        .then((response) => {
          const { count,results, total_pages } = response.data;
          this.totalservices = count;
          this.services = results.map(this.getDisplayService);
          this.totalPages = total_pages;
          console.log(response.data);
        })
        .catch((e) => {
          console.log(e);
        });
    },
    handlePageChange(value) {
      this.page = value;
      this.retrieveServices();
    },
    handlePageSizeChange(size) {
      this.pageSize = size;
      this.page = 1;
      this.retrieveServices();
    },



    refreshList() {
      this.retrieveServices();
    },

    deleteService(id) {
      http.deleteItem("Services",id)
        .then(() => {
          this.refreshList();
        })
        .catch((e) => {
          console.log(e);
        });
    },
    getDisplayService(service) {
      return {
        id: service.id,
        project: service.project ,
        ip: service.ip,
        port: service.port,
      };
    },
     startScan(){

     },
     close(){
      this.dialog = false
        this.$nextTick(() => {

        })

     },
    closeDetail() {
          this.detail_dialog = false;
          this.service_id = -1;
      },
    handleClick(row) {
      this.service_id = row.id;
      this.detail_dialog = true
    },
    save () {
        if (this.editedIndex > -1) {
          Object.assign(this.desserts[this.editedIndex], this.editedItem)
        } else {
          this.desserts.push(this.editedItem)
        }
        this.close()
      },
    closeCreateModal(proje) {
      this.dialog = false;
      this.$nextTick(() => {
        this.$refs.form.reset();
      });
    },
    getProjects() {

      if (!this.has_next_page_project) {
        return;
      }
      http.getList("Projects", {page:this.prooject_page, per_page:this.projects_per_page}, true)
        .then((response) => {
          this.has_next_page_project = response.data.next ;
          this.projects.push(...response.data.results.map(this.getDisplayProject));
        })
        .catch((e) => {
          console.log(e);
        });
    },
    getDisplayProject(project) {
      return {
        id: project.id,
        name: project.name,
      };
    },
    onIntersect () {
            console.log('load more...')
            this.prooject_page += 1
            this.getProjects()
        },

  },
  mounted() {
    this.retrieveServices();
    this.getProjects();
  },

  watch: {
      dialog (val) {
        val || this.close()
      },

    },
};
</script>

<style>
.list {
  max-width: 750px;
}
</style>
Footer
