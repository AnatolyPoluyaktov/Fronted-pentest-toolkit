<template>

<div>
    <DataTableVue :items="services" :workers="workers" :totalitems="totalservices" :title="title" :headers="headers"
        :formTitle="formTitle" :url="url" :type_of_items="type_of_items" :totalPages="totalPages" :isnotProject="true"
        @get-items="retrieveServices">

        <template v-slot:createmodal>

            <v-dialog hide-overlay v-model="CreateDialog" max-width="500px">
                                <template v-slot:activator="{ on, attrs }">
                                    <v-btn color="primary" dark class="mb-2 ma-2" v-bind="attrs" v-on="on">
                                        Add Service
                                    </v-btn>
                                </template>
            <v-card>
                <v-card-title>
                    <span class="text-h5">Create Service</span>
                </v-card-title>

                <v-card-text>

                    <v-container>
                        <v-row>
                            <v-col cols="12" sm="6" md="4">
                                <v-text-field v-model="CreateItem.name" label="name"></v-text-field>
                            </v-col>
                            <v-col cols="12" sm="6" md="4">
                                <v-text-field v-model="CreateItem.port" label="port" hide-details single-line type="number"></v-text-field>
                            </v-col>

                            <v-col cols="12" sm="6" md="4">
                                <v-select :items="states" label="port state" v-model="CreateItem.state" item-text="name"
                                    required></v-select>
                            </v-col>
                            <v-col cols="12" sm="6" md="4">
                                <v-text-field v-model="CreateItem.product" label="product"></v-text-field>
                            </v-col>
                            <v-col cols="12" sm="6" md="4">
                                <v-text-field v-model="CreateItem.version" label="version"></v-text-field>
                            </v-col>
                            <v-col cols="12" sm="6" md="4">
                                <v-autocomplete v-model="CreateItem.ip" :items="ips"
                                    :search-input.sync="UpdatingIps" item-text="ip" label="Search Ip"
                                    placeholder="Start typing to Search" return-object required></v-autocomplete>
                            </v-col>

                            <v-col cols="12" sm="6" md="4">
                                <v-autocomplete v-model="CreateItem.project" :items="projects"
                                    :search-input.sync="UpdatingProjects" item-text="name" label="Search Projects"
                                    placeholder="Start typing to Search" return-object required></v-autocomplete>
                            </v-col>


                        </v-row>
                    </v-container>
                </v-card-text>
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="blue darken-1" text @click="closeCreateModal">
                        Cancel
                    </v-btn>
                    <v-btn color="blue darken-1" text @click="save">
                        Save
                    </v-btn>
                </v-card-actions>

            </v-card>

            </v-dialog>

        </template>
        <template v-slot:filters_after_project>
            <td>
                 <v-text-field v-model="ip" type="String" label=" search by ip"></v-text-field>
                     </td>
                     <td>
                 <v-text-field v-model="port" type="number" label=" search by port"></v-text-field>
                     </td>


                     <td>
                 <v-text-field v-model="vulnerability_count" type="number" label=" search count"></v-text-field>
                     </td>
        </template>
        <template v-slot:actions="{ item }">





            <v-btn color="primary" @click="OpenDetailCard(item)">
                Detail Info
            </v-btn>


        </template>

    </DataTableVue>
    <DetailCard :dialog="detail_dialog" @close="closeDetailModal" :item="detail_item"></DetailCard>
</div>
</template>

<script>
import http from "@/http";
import DataTableVue from "@/components/DataTable.vue";
import DetailCard from "@/components/DetailCards/EntityInfoCard.vue"
import RelatedEntityCardVue from "@/components/DetailCards/RelatedEntityCard.vue";
export default {
    components: {
        DataTableVue,
        DetailCard,
        RelatedEntityCardVue
    },
    name: "service-list",
    data() {
        return {
            type_of_items: "services",
            url: "common/services/",
            formTitle: "Create Service",
            title: "Services",
            workers: ["nuclei-scan", "website-generator", "nmap-scan"],
            services: [],

            singleSelect: false,
            totalservices: 0,
            selected: [],


            detail_dialog: false,
            project: null,
            service_id: null,
            detail_dialog: false,
            project: null,
            projects : [],
            filter : {service__id: 0},
            ips : [],
            states:["open","closed","filtered"],
            ip: "",
            projects: [],
            detail_item: null,
            port: "",
            UpdatingIps: "",
            vulnerability_count: null,
            UpdatingProjects: "",
            CreateItem: {
                ip: { id: null, ip: "" },
                name: "",
                port: "",
                protocol: "",
                state: "",
                product: "",
                version: "",
                project: { id: null, name: ""}

            },
            headers: [
                { text: "ID", align: "start", sortable: false, value: "id" },
                { text: "Project ID", sortable: false, value: "project" },
                { text: "Ip", value: "ip", sortable: false},
                { text: "port", value: "port", sortable: false },
                { text: "vulnerabilties count", value: "vulnerabilties_count", sortable: false },

                { text: "Actions", value: "actions", sortable: false },

            ],
            page: 1,
            totalPages: 0,
            pageSize: 6,
            pageSizes: [6, 9, 12],
            dialogRunWorker: false,
            CreateDialog: false,

        };
    },
    methods: {
        getRequestParams(ip, port, vulnerability_count) {
            let params = {};
            console.log("vulnerability_count", vulnerability_count)
            if (vulnerability_count){
                params["vulnerabilities__gte"] = vulnerability_count;
            }
            if (ip) {
                params["ip"] = ip;
            }
            if (port) {
                params["port"] = port;
            }

            return params;
        },
        retrieveServices(params) {
            console.log("port",this.port)

            let extra_params = this.getRequestParams(this.ip, this.port, this.vulnerability_count);
            params = { ...params, ...extra_params };
            console.log("params", params)
            http.getList("Services", params, true)
                .then((response) => {
                    const { count, results, total_pages } = response.data;
                    this.totalservices = count;
                    this.services = results.map(this.getDisplayService);
                    this.totalPages = total_pages;
                    console.log(response.data);
                })
                .catch((e) => {
                    console.log(e);
                });
        },
        handlePageChange(value) {
            this.page = value;
            this.retrieveServices();
        },
        handlePageSizeChange(size) {
            this.pageSize = size;
            this.page = 1;
            this.retrieveServices();
        },

        async getProjects(val) {

            try {
                let response = (
                    await http.getList(
                        "Projects", { name__icontains: val }, true

                    )
                ).data;

                const { next, results } = response
                this.projects = results
                this.has_next_page_projects = next !== null
                console.log(response)

                // this.projects.push(...results.map(this.getDisplayProject))
                // this.has_next_page_projects = next !== nulls
            } catch (error) {
                console.error(error);
                // expected output: ReferenceError: nonExistentFunction is not defined
                // Note - error messages will vary depending on browser
            }

        },



        async GetIps(ip) {
        let response = (
                await http.getList(
                    "Ips", {ip__icontains: ip},
                    true
                )
            ).data;
          this.ips = response.results.map(this.getDisplayIp)
        },

        getDisplayIp(Ip) {
            return {
                id: Ip.id,
                ip: Ip.ip,
            };
        },
        refreshList() {
            this.retrieveServices();
        },


        deleteService(id) {
            http.deleteItem("Services", id)
                .then(() => {
                    this.refreshList();
                })
                .catch((e) => {
                    console.log(e);
                });
        },
        getDisplayService(service) {
            return {
                id: service.id,
                project: service.project,
                ip: service.ip,
                port: service.port,
                protocol: service.protocol,
                vulnerabilties_count: service.vulnerabilties_count,
            };
        },

        async save() {
            let post_data = {
                ip: this.CreateItem.ip.id,
                port: this.CreateItem.port,
                name: this.CreateItem.name,
                protocol: this.CreateItem.protocol,
                state: this.CreateItem.state,
                product: this.CreateItem.product,
                version: this.CreateItem.version,

            }
            console.log('send_services')
            let response = (
                await http.createItem(
                    "Services",
                    {
                        project: this.CreateItem.project.id,
                        services: [post_data],
                        source: "manual",
                    }
                    ,
                    true
                )
            )
            this.closeCreateModal()
            window.location.reload()
        },

        closeDetailModal() {
            this.detail_dialog = false
            this.$nextTick(() => {
                this.detail_item - null
            })

        },
        OpenDetailCard(item){
            this.detail_dialog = true
            this.detail_item = item
        },

        OpenVulnerabilityCard(item){
            console.log(item)
            this.vulnerability_dialog = true
            this.filter.service__id = item.id
        },


        closeCreateModal() {
            this.CreateDialog = false
            this.$nextTick(() => {
                this.CreateItem = Object.assign({}, {
            ip: {id : ull, ip: ""},
            name: "",
            port: "",
            protocol: "",
            state: "",
            product: "",
            version: "",
            project_id:{id: null, name: ""} ,
        })
            })
        },

        closeVulnerabilityCard(){
            this.vulnerability_dialog = false
            this.$nextTick(() => {
                this.filter.service__id = null
            })
        },
    },

    mounted() {
        let params = {
            page: this.page,
            per_page: this.pageSize,
        };
        this.retrieveServices(params);


    },

    watch: {
        CreatDialog(val) {
            val || this.closeCreateModal()
        },


        UpdatingIps(val){
            this.GetIps(val)
        },
        UpdatingProjects(val){
            this.getProjects(val)
        }

    },
};
</script>

<style>
.list {
    max-width: 750px;
}
</style>
  Footer
