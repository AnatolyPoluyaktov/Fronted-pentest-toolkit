<template>

    <div>
        <v-row justify="center">

            <v-dialog v-model="dialog" max-width="500px">



                <v-card>


                    <v-card-title>
                        <span class="text-h5">{{ formTitle }}</span>
                    </v-card-title>

                    <v-card-text>
                        <v-container>
                            <v-row>

                                <v-col cols="12" sm="6" md="5">
                                    <v-autocomplete v-model="project" :items="projects" item-text="name" item-value="id"
                                        label="Search project" return-object autocomplete="off">
                                        <template v-slot:append-item>
                                            <div v-intersect="onIntersect" class="pa-4 teal--text">
                                                Loading more projects ...
                                            </div>
                                        </template>
                                    </v-autocomplete>
                                </v-col>

                                <slot name="create properties">

                                </slot>
                            </v-row>
                        </v-container>
                    </v-card-text>

                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="blue darken-1" text @click="">
                            Cancel
                        </v-btn>
                        <v-btn color="blue darken-1" text @click="">
                            Save
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

        </v-row>

    </div>
</template>

<script>
import http from "@/http";
export default {
    props: {
        formTitle: {
            type: String,
            default: "Create Service",
        },
        dialog: {
            type: Boolean,
            default: false,
        },
    },





    data() {
        return {
            has_next_page_project: true,
            project_page:0,
            per_page:1,

project: null,
project_id: null,
projects: [],
CreateItem: {
        project: { id: -1, name: "" },
        ip: {id : -1, ip: ""},
        name: "",
        port: "",
        protocol: "",
        state: "",
        product: "",
        version: ""}

        };
    },
    methods: {

        close() {
            this.dialog = false
            this.$nextTick(() => {

            })

        },
        async save() {
            this.post_data = {
                ip: this.CreateItem.ip.id,
                port: this.CreateItem.port,
                name: this.CreateItem.name,
                protocol: this.CreateItem.protocol,
                state: this.CreateItem.state,
                product: this.CreateItem.product,
                version: this.CreateItem.version,
                project_id: this.CreateItem.project_id,
            }
            console.log('send_services')
            let response = (
                await http.createItem(
                    "Services",
                    this.post_data,
                    true
                )
            )
            this.close()
            //window.location.reload()
        },

        getProjects() {

            if (!this.has_next_page_project) {
                return;
            }
            http.getList("Projects", { page: this.prooject_page, per_page: this.projects_per_page }, true)
                .then((response) => {
                    this.has_next_page_project = response.data.next;
                    this.projects.push(...response.data.results.map(this.getDisplayProject));
                })
                .catch((e) => {
                    console.log(e);
                });
        },
        getDisplayProject(project) {
            return {
                id: project.id,
                name: project.name,
            };
        },
        onIntersect() {
            console.log('load more...')
            this.prooject_page += 1
            this.getProjects()
        },

    },
    mounted() {
        console.log(this.projects)
        this.getProjects();
    },

    watch: {
        dialog(val) {
            val || this.close()
        },

    },
};

</script>
