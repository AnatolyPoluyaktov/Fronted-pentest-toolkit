<template>
    <v-row align="center" class=" px-3 mx-auto">

        <v-col cols="7">
            <v-row>
                <v-col cols="2" sm="3">
                    <v-select v-model="pageSize" :items="pageSizes" label="Items per Page"
                        @change="handlePageSizeChange"></v-select>
                </v-col>

            </v-row>

        </v-col>

        <v-col cols="12" sm="12">
            <v-card class="mx-auto" tile>

                <v-data-table v-model="selected" :single-select="singleSelect" :headers="headers" :items="items"
                    :hide-default-footer="true" show-select disable-pagination class="elevation-1 ">
                    <template v-slot:top>
                        <v-toolbar flat>
                            <v-toolbar-title>{{ title }}</v-toolbar-title>
                            <v-divider class="mx-4" inset vertical></v-divider>

                            <v-spacer></v-spacer>

                            <v-btn color="primary" dark class="mb-2 ma-2" @click="page = 1; GetItems() ">
                                Search
                            </v-btn>
                            <div v-if="isnotProject">
                            <v-dialog v-if="worker_not_empty" hide-overlay v-model="dialogStartScan" max-width="500px">
                                <template v-slot:activator="{ on, attrs }">
                                    <v-btn color="primary" dark class="mb-2 ma-2" v-bind="attrs" v-on="on">
                                        Start Scan
                                    </v-btn>
                                </template>
                                <v-card>
                                    <v-card-title>
                                        <span class="text-h5">Create Task</span>
                                    </v-card-title>

                                    <v-card-text>

                                        <v-container>
                                            <v-row>
                                                <v-col cols="12" sm="7" md="5">
                                                    <v-autocomplete v-model="project"  :search-input.sync="UpdateProjects" :items="projects" item-text="name"
                                                        item-value="id" label="Search project" return-object
                                                        autocomplete=off
                                                        >

                                                    </v-autocomplete>
                                                </v-col>
                                                <v-col cols="12" sm="6" md="4">
                                                    <v-select :items="workers" label="worker" v-model="worker"
                                                        required></v-select>
                                                </v-col>
                                            </v-row>
                                        </v-container>
                                    </v-card-text>
                                    <v-card-actions>
                                        <v-spacer></v-spacer>
                                        <v-btn color="blue darken-1" text @click="closeStartScanModal">
                                            Cancel
                                        </v-btn>
                                        <v-btn color="blue darken-1" text @click="startScan">
                                            Start Worker
                                        </v-btn>
                                    </v-card-actions>

                                </v-card>
                            </v-dialog>
                        </div>

                            <slot name="createmodal"></slot>

                            <v-dialog v-model="dialogDelete" max-width="500px">
                                <template v-slot:activator="{ on, attrs }">
                                    <v-btn color="primary" dark class="mb-2 ma-2" v-bind="attrs" v-on="on">
                                        Delete
                                    </v-btn>
                                </template>
                                <v-card>
                                    <v-card-title class="text-h5">Are you sure you want to delete selected
                                        {{ type_of_items }}?</v-card-title>
                                    <v-card-actions>
                                        <v-spacer></v-spacer>
                                        <v-btn color="blue darken-1" text @click="closeDelete">Cancel</v-btn>
                                        <v-btn color="blue darken-1" text @click="deleteItemConfirm">OK</v-btn>
                                        <v-spacer></v-spacer>
                                    </v-card-actions>
                                </v-card>
                            </v-dialog>

                        </v-toolbar>
                    </template>

                    <template v-slot:body.prepend>
                        <tr>

                            <slot name="filters_before_project">
                                <td>

                                </td>

                            </slot>
                                <td>
                                    <v-text-field v-model="id" type="number" label="id"></v-text-field>
                                </td>


                            <td v-if="isnotProject">
                                <v-text-field v-model="project" type="number" label="project id"></v-text-field>
                            </td>
                            <slot name="filters_after_project">
                                <td>

                                </td>
                            </slot>
                        </tr>
                    </template>
                    <template v-slot:item.actions="{ item }">

                        <slot name="actions" :item="item"></slot>
                    </template>
                </v-data-table>

            </v-card>
        </v-col>

        <v-col cols="12" mx="9">

            <v-pagination v-model="page" :length="totalPages" total-visible="7" next-icon="mdi-menu-right"
                prev-icon="mdi-menu-left" @input="handlePageChange"></v-pagination>

        </v-col>

    </v-row>
</template>

<script>
import http from "@/http";
export default {
    components: {
    },
    name: "data-table",
    props: {
        items: {
            type: Array,
            default() {
                return []
            }
        },
        workers: {
            type: Array,
            default() {
                return []
            }
        },

        totalitems: {
            type: Number,
            default: 0
        },
        title: {
            type: String,
            default: ""
        },
        headers: {
            type: Array,
            default() {
                return []
            }
        },
        formTitle: {
            type: String,
            default: ""
        },
        url: {
            type: String,
            default: ""
        },
        type_of_items: {
            type: String,
            default: ""
        },
        isnotProject: {
            type: Boolean,
            default: false
        },
        loading: {
            type: Boolean,
            default: true
        },
        totalPages: {
            type: Number,
            default: 0
        },
    },

    name: "DataTable",
    data() {
        return {
            dialogStartScan: false,
            Createdialog: false,
            dialogDelete: false,
            singleSelect: false,
            selected: [],
            item_id: null,
            project: null,
            id: null,

            projects: [],
            worker: "",
            page: 1,
            search: "",
            pageSize: 6,
            pageSizes: [6, 9, 12],
            dialogRunWorker: false,

            dialogDelete: false,


            UpdateProjects: "",

        };
    },
    methods: {

        async deleteItemConfirm() {
            await this.DeleteSelectedItems();

        },
        async DeleteSelectedItems() {
            for (var i = 0; i < this.selected.length; i++) {

                await http.deleteItem(this.url, this.selected[i].id)

            }
            this.closeDelete()
            window.location.reload()

        },

        getRequestParams(id, project, page, pageSize) {
            let params = {};
            if (id){
                params["id"] = id;
            }
            if (project) {
                params["project"] = project;
            }
            if (page) {
                params["page"] = page;
            }
            if (pageSize) {
                params["per_page"] = pageSize;
            }
            return params;
        },
        GetItems() {
            console.log(this.items.length)
            this.loading = true;
            const params = this.getRequestParams(
                this.id,
                this.project,
                this.page,
                this.pageSize
            );
            console.log("params", params)
            this.$emit("get-items", params);
            if (this.items.length > 0) {

            }
        },
        handlePageChange(value) {
            this.page = value;
            this.GetItems();
        },
        handlePageSizeChange(size) {
            this.pageSize = size;
            this.page = 1;
            this.GetItems();
        },

        refreshList() {
            this.GetItems();
        },

        async startScan() {

            let items_for_scan = this.selected.filter(item => {
                item.project = this.project.id
            })
            let params = {}
            params[this.type_of_items] = items_for_scan
            params["project"] = this.project.id
            await http.run_scan(this.worker, params)
            this.closeStartScanModal()
            window.location.reload()
        },

        async getProjects(val) {

            try {
                let response = (
                await http.getList(
                    "Projects", {name__icontains:val}, true

                )
            ).data;

             const {next , results} = response
            this.projects = results
            this.has_next_page_projects = next !== null
                console.log(response)

                // this.projects.push(...results.map(this.getDisplayProject))
                // this.has_next_page_projects = next !== nulls
            } catch (error) {
                console.error(error);
                // expected output: ReferenceError: nonExistentFunction is not defined
                // Note - error messages will vary depending on browser
            }

        },
        getDisplayProject(project) {
            return {
                id: project.id,
                name: project.name,
            };
        },
        // onIntersect() {
        //     console.log('load more.. project')
        //     this.prooject_page += 1
        //     this.getProjects()
        // },
        closeStartScanModal() {
            this.dialogStartScan = false
            this.$nextTick(() => {
                this.project = null

                this.projects = []
                this.worker = null
                this.selected = []
            })
        },







        closeDelete() {
            this.dialogDelete = false
            this.$nextTick(() => {
                console.log(this.selected)
                this.selected = []
            })
        },
    },
    mounted() {
       //this.getProjects();
        //console.log(this.projects)

    },
    computed : {
        worker_not_empty() {
            console.log("not empty", this.worker.length )

            return this.workers.length > 0
        },
    },

    watch: {
        // Createdialog(val) {
        //     console.log(val)
        //     val || this.closeCreateModal()
        // },
        dialogStartScan(val) {
            val || this.closeStartScanModal()
        },

        dialogDelete(val) {
            val || this.closeDelete()
        },
        UpdateProjects(val) {
           this.getProjects(val)
        },

    },
};
</script>

<style>
.list {
    max-width: 750px;
}
</style>
  Footer
